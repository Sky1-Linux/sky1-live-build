#!/bin/bash
# Sky1 Linux live-build build script
# Builds complete ISO ready for deployment

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$SCRIPT_DIR"

echo "=== Sky1 Linux Live Build ==="
echo "Working directory: $SCRIPT_DIR"
echo ""

# Run live-build
lb build noauto "${@}" 2>&1 | tee build.log

# Check if build succeeded
if [ ! -d "binary" ]; then
    echo "ERROR: Build failed - no binary directory"
    exit 1
fi

# Run binary hook manually if needed (in case it didn't run)
if [ ! -f "binary/live/vmlinuz" ] && [ -f "config/hooks/binary/0100-sky1-grub-dtb.hook.binary" ]; then
    echo ""
    echo "Running binary hook..."
    bash config/hooks/binary/0100-sky1-grub-dtb.hook.binary
fi

# Verify boot files exist
if [ ! -f "binary/live/vmlinuz" ] || [ ! -f "binary/live/initrd.img" ]; then
    echo "ERROR: Boot files missing in binary/live/"
    ls -la binary/live/
    exit 1
fi

# Check for EFI image
if [ ! -f "binary/boot/grub/efi.img" ]; then
    echo "ERROR: EFI image not found at binary/boot/grub/efi.img"
    exit 1
fi

# Patch EFI image with Sky1 GRUB and config
echo ""
echo "Patching EFI image..."
EFI_MOUNT=$(mktemp -d)
mount -o loop binary/boot/grub/efi.img "$EFI_MOUNT"

# Install patched Sky1 GRUB
if [ -f "config/includes.chroot/usr/share/sky1/grubaa64-sky1.efi" ]; then
    cp config/includes.chroot/usr/share/sky1/grubaa64-sky1.efi "$EFI_MOUNT/EFI/boot/bootaa64.efi"
    cp config/includes.chroot/usr/share/sky1/grubaa64-sky1.efi "$EFI_MOUNT/EFI/boot/grubaa64.efi"
    echo "Installed patched Sky1 GRUB"
fi

# Copy GRUB config to /GRUB/grub.cfg (patched GRUB looks for lowercase grub.cfg)
mkdir -p "$EFI_MOUNT/GRUB"
rm -f "$EFI_MOUNT/GRUB/"*.CFG "$EFI_MOUNT/GRUB/"*.cfg 2>/dev/null || true
if [ -f "config/bootloaders/grub-efi/grub.cfg" ]; then
    cp config/bootloaders/grub-efi/grub.cfg "$EFI_MOUNT/GRUB/grub.cfg"
    echo "Installed GRUB config"
fi

umount "$EFI_MOUNT"
rmdir "$EFI_MOUNT"
echo "EFI image patched"

# Also copy GRUB config to ISO filesystem at /GRUB (where GRUB prefix points)
mkdir -p binary/GRUB
cp config/bootloaders/grub-efi/grub.cfg binary/GRUB/grub.cfg
# Also copy patched GRUB to ISO EFI directory
mkdir -p binary/EFI/boot
cp config/includes.chroot/usr/share/sky1/grubaa64-sky1.efi binary/EFI/boot/bootaa64.efi
cp config/includes.chroot/usr/share/sky1/grubaa64-sky1.efi binary/EFI/boot/grubaa64.efi
echo "Copied GRUB and config to ISO filesystem"

# Generate ISO with timestamp label
echo ""
echo "=== Generating ISO ==="
ISO_DATE=$(date +%Y%m%d)
ISO_LABEL="SKY1_${ISO_DATE}"
ISO_NAME="sky1-linux-${ISO_DATE}.iso"

# Update grub.cfg with current label
echo "Setting ISO label: $ISO_LABEL"
sed -i "s|/dev/disk/by-label/SKY1_LIVE|/dev/disk/by-label/${ISO_LABEL}|g" binary/GRUB/grub.cfg

# Also update the EFI image grub.cfg
EFI_MOUNT=$(mktemp -d)
mount -o loop binary/boot/grub/efi.img "$EFI_MOUNT"
sed -i "s|/dev/disk/by-label/SKY1_LIVE|/dev/disk/by-label/${ISO_LABEL}|g" "$EFI_MOUNT/GRUB/grub.cfg"
umount "$EFI_MOUNT"
rmdir "$EFI_MOUNT"

xorriso -as mkisofs \
    -r -J -joliet-long -l -iso-level 3 \
    -A "Sky1 Linux" \
    -V "$ISO_LABEL" \
    -e boot/grub/efi.img \
    -no-emul-boot \
    -append_partition 2 0xef binary/boot/grub/efi.img \
    -o "$ISO_NAME" \
    binary/

echo ""
echo "=== Build Complete ==="
ls -lh "$ISO_NAME"
echo ""
echo "To deploy to test partition:"
echo "  ./scripts/deploy-test.sh $ISO_NAME"
